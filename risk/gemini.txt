def risk_manager(symbol, account_balance, direction):
    # 1. 获取基础数据
    candles_1h = fetch_candles(symbol, '1h', limit=50)
    btc_candles = fetch_candles('BTC/USDT', '1h', limit=50)
    order_book = fetch_order_book(symbol)

    # 2. 计算ATR (波动率)
    atr = calculate_atr(candles_1h, period=14)
    current_price = candles_1h[-1]['close']

    # 3. 检查相关性风险 (Veto 逻辑)
    btc_trend = get_trend(btc_candles)
    if btc_trend == 'BEARISH' and direction == 'LONG':
        return {"action": "REJECT", "reason": "BTC trend mismatch"}

    # 4. 检查流动性风险 (Veto 逻辑)
    slippage_risk = check_depth(order_book, trade_size_estimate=1000)
    if slippage_risk > 0.005: # 滑点超过0.5%
        return {"action": "REJECT", "reason": "Low Liquidity"}

    # 5. 动态止损位计算
    stop_loss_price = current_price - (2 * atr) if direction == 'LONG' else current_price + (2 * atr)
    sl_percent = abs(current_price - stop_loss_price) / current_price

    # 6. 仓位计算
    risk_per_trade = 0.02 # 2% 本金风险
    max_loss_amount = account_balance * risk_per_trade
    position_size = max_loss_amount / sl_percent

    return {
        "action": "ACCEPT",
        "size_usdt": position_size,
        "stop_loss_price": stop_loss_price
    }